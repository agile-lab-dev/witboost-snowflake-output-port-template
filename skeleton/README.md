# Snowflake Output Port template

Use this template to automatically create an Output Port based on a Snowflake instance.

## Using the template

### Prerequisites

A Data Product should already exist in order to attach the new components to it. The component **Snowflake Storage** should exist in the Data Product.

---

### Component basic information

This section includes the basic information that any Component of Data Mesh Boost must have

- Name: Required name used for display purposes on your Data Product
- Fully Qualified Name: Workload fully qualified name, this is optional as will be generated by the system if not given by you
- Description: A short description to help others understand what this Workload is for.
- Domain: The Domain of the Data Product this Workload belongs to. Be sure to choose it correctly as is a fundamental part of the Workload and cannot be changed afterwards.
- Data Product: The Data Product this Workload belongs to, be sure to choose the right one.
- Identifier: Unique ID for this new entity inside the domain. Don't worry to fill this field, it will be automatically filled for you.
- Development Group: Development group of this Data Product. Don't worry to fill this field, it will be automatically filled for you.
- Depends On: If you want your workload to depend on other components from the Data Product, you can choose this option.

    > In order for the Snowflake Output Port to create view on top of the tables, we need to add Snowflake Storage component in the **dependsOn** field.

*Example:*

| Field name              | Example value                                                                                           |
|:------------------------|:--------------------------------------------------------------------------------------------------------|
| **Name**                | Snowflake Vaccinations Output Port                                                                      |
| **Description**         | Offers insight in the COVID-19 Vaccinations                                                             |
| **Domain**              | domain:healthcare                                                                                       |
| **Data Product**        | system:healthcare.vaccinationsdp.0                                                                      |
| ***Identifier***        | Will look something like this: *marketing.healthcare.0.snowflake-vaccinations-output-port*              |
| ***Development Group*** | Might look something like this: *group:datameshplatform* Depends on the Data Product development group  |
| ***dependsOn***         | urn:dmb:cmp:healthcare:vaccinationsdp:0:snowflake-vaccinations-storage                                  |

---

### Provide Output Port deployment information

This section will tell the Output Port where to get the data from inside Snowflake

- Database: (Optional) Enter the name of the database you want to sync data into. If not specified the Domain name will be set as default value.
- Schema: (Optional) Enter the name of the default schema. If not specified the value `<DP_name>_<DP_version>` will be set as default value. (The version will be rendered without the dots)
- View name: Enter the name of the view that will be created inside the Snowflake Schema
- Table name: Enter the name of the table used as source to create the view on top of it


*Example:*

| Field name     | Example value           |
|:---------------|:------------------------|
| **Database**   | HEALTHCARE              |
| **Schema**     | vaccinationsdp          |
| **Table name** | vaccinations_clean      |
| **View name**  | vaccinations_clean_view |

---

### Choose a location

Every component needs a host where the generated code will be saved. The default is `gitlab.com`. Refer to your team to understand the structure on how to use your repository to save these components.

- Host: The host where the repository will be created. By default is `gitlab.com`
- User/Group: A group or a user that the repository belongs to, e.g. 'group/sub-group/sub-sub-group' or 'name.surname'. There are two ways of creating a new component. One way of creating it is by making a monorepo (in that way you will never change the field 'Repository' and it will always be a repository containing your data product, and you will only need to change the root directory). The second way of creating a new component is by doing it always in another repository (in that case the root directory will always be '.' and you will always change the repository field).
- Repository: The name of the repository
- Root Directory: The path that will be used as the repository root for this component. For monorepos this will be different for each component.

*Example:*

| Field name        | Example value                                  |
|:------------------|:-----------------------------------------------|
| ***Host***        | gitlab.com                                     |
| **User/Group**    | MyCompany/mesh.repository/sandbox/vaccinations |
| **Repository**    | SnowflakeVaccinationsOutputPort                |
| **RootDirectory** | .                                              |

After this the system will show you the summary of the template, and you can go back and edit or go ahead and create the Component. 

After clicking on "Create" the registering of the Component will start. If no errors occurred it will go through the 3 phases (Fetching, Publishing and Registering) and will give you the links to the newly created Repository and the component in the Catalog.

---

### Snowflake Output port deployment information

The deployment of this component will create a Snowflake View inside the specified Database and Schema. In order to cover our use-case, described in the previous sections, we are assuming that by default the view and the other Snowflake resources will be created inside the default Database Schema, following the convention explained earlier.

Then, we have several options: as explained in the previous sections we are able to create futher multiple tables either with the Storage component or the SQL Workload (with a dedicated query inside the sql file). As a result, we can use one of these tables (or multiple tables) already provided by one of these components (or multiple components) to create our view on top of it(/them). Of course, in that case we need to specify the proper dependencies by adding the involved components inside the component DependsOn section of this component and change the input data accordingly, otherwise the Data Product deployment will not work as expected.

By default, this component will create a View on top of the Airbyte source table that will be created inside Snowflake. The View structure will follow the source table structure obviously, but the fields included will be the ones specified inside the component descriptor, listed under the `dataContract > schema` section of the `catalog-info.yaml` file. **You must change the tableName specified as source and the schema to customize your view**.

#### Custom View

The user, as already mentioned, has also the possibility to create a custom view based on different/multiple tables. In addition, you can leverage the features offered by the View to apply **masking and row access policies**. In that case, the features explained until now will not do the job, and you may need a custom view.

To create a custom view, you simply need to provide the query needed to create it by manually editing the `catalog-info.yaml` file. In particular, you need to add it in a new `customView` field inside the `specific` section of the `catalog-info.yaml` file, as showed below:

!! Be aware that we had followed certain rules for naming the specifics inside the catalog-info file (For example - Added suffixes for schemaName and appended it with majorVersion) regardless of the value being a default one (or) a custom one. During any point of time, if you have any doubts regarding these names, please refer to the catalog-info file of **Snowflake Storage** as this would be the starting point of the tutorial.

```yaml
  components:
    - id: domain:healthcare.vaccinationsdp.0.snowflake-output-port
      name: vaccinationsdp
      fullyQualifiedName: Vaccinations Data
      description: Vaccinations Data
      kind: outputport
      owners:
        - group:bigdata
      infrastructureTemplateId: urn:dmb:itm:cdp-aws-s3:1.0.0
      useCaseTemplateId: urn:dmb:utm:template-id-1:1.0.0
      dependsOn: [ ]
      platform: CDP_AWS
      technology: CDP_S3
      dataContract:
        schema:
          - name: date
            dataType: DATE
            constraint: NO CONSTRAINT
          - name: location_key
            dataType: TEXT
            constraint: NO CONSTRAINT
          - name: new_persons_vaccinated
            dataType: NUMBER
            constraint: NO CONSTRAINT
          - name: new_persons_fully_vaccinated
            dataType: NUMBER
            constraint: NO CONSTRAINT
          - name: new_vaccine_doses_administered
            dataType: NUMBER
            constraint: NO CONSTRAINT
          - name: cumulative_persons_vaccinated
            dataType: NUMBER
            constraint: NO CONSTRAINT
          - name: cumulative_persons_fully_vaccinated
            dataType: NUMBER
            constraint: NO CONSTRAINT
          - name: cumulative_vaccine_doses_administered
            dataType: NUMBER
            constraint: NO CONSTRAINT
      tags: [ ]
      specific:
        viewName: vaccinations_clean_view
        tableName: vaccinations_clean
        database: HEALTHCARE
        schema: VACCINATIONSDP_0
        customView: CREATE VIEW IF NOT EXISTS HEALTHCARE.VACCINATIONSDP_0.vaccinations_clean_view AS (SELECT * FROM HEALTHCARE.VACCINATIONSDP_0.vaccinations_clean);
```

**Please note that when providing a customView query, the source tableName and the dataContract schema specified will be not used to create the View, but those parts must be aligned and compiled because the platform will check their consistency through policies.**